<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°å­—è·‘é…·ï¼šå››åˆ™è¿ç®—åœ°ç‹±ç‰ˆ</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        body {
            background-color: #0f172a;
            color: white;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB",
                         "Microsoft YaHei", sans-serif;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .overlay-fullscreen {
            position: fixed;
            inset: 0;
        }
        .center-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .glass-panel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .btn {
            border: none;
            outline: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            width: 100%;
            height: 52px;
            background-image: linear-gradient(to right, #2563eb, #4f46e5);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:active {
            opacity: 0.85;
        }
        .btn-secondary {
            width: 100%;
            height: 44px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .btn-secondary:active {
            border-color: #fff;
            color: #fff;
        }
        .btn-light {
            width: 100%;
            height: 48px;
            background: #fff;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .btn-light:active {
            background: #e5e5e5;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: #374151;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #facc15;
            border: none;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
            margin-top: -6px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #facc15;
            border: none;
        }
    </style>
</head>
<body>

<!-- æ¸¸æˆå±‚ -->
<div id="gameContainer" class="overlay-fullscreen" style="display:none;">
    <canvas id="gameCanvas"></canvas>

    <!-- é¡¶éƒ¨ HUD -->
    <div style="
        position:absolute;top:0;left:0;right:0;
        padding:16px;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        pointer-events:none;
    ">
        <!-- å·¦ï¼šå‰©ä½™æ’æ•° + å½“å‰å€¼ -->
        <div style="display:flex;flex-direction:column;gap:10px;pointer-events:auto;">
            <!-- å‰©ä½™æ’æ•° -->
            <div class="glass-panel" style="padding:8px 16px;">
                <div style="
                    display:flex;
                    align-items:center;
                    gap:6px;
                    font-size:10px;
                    text-transform:uppercase;
                    font-weight:bold;
                    letter-spacing:0.08em;
                    color:#9ca3af;
                    margin-bottom:4px;
                ">
                    <span>ğŸ å‰©ä½™æ’æ•°</span>
                </div>
                <div style="font-size:24px;font-weight:900;font-family:monospace;">
                    <span id="stepsDisplay">20</span>
                    <span style="font-size:12px;color:#6b7280;">/20</span>
                </div>
                <div style="
                    width:140px;height:4px;
                    background:#374151;border-radius:999px;
                    margin-top:8px;overflow:hidden;
                ">
                    <div id="progressBar" style="
                        width:0%;
                        height:100%;
                        background-image:linear-gradient(to right,#3b82f6,#8b5cf6);
                        transition:width 0.25s ease;
                    "></div>
                </div>
            </div>

            <!-- å½“å‰æ•°å€¼ -->
            <div class="glass-panel" style="padding:8px 16px;">
                <div style="font-size:12px;color:#9ca3af;">å½“å‰æ•°å€¼</div>
                <div id="scoreDisplay" class="neon-text" style="
                    font-size:20px;font-weight:700;color:#34d399;
                ">
                    2
                </div>
            </div>
        </div>

        <!-- å³ï¼šé€Ÿåº¦æ§åˆ¶ -->
        <div class="glass-panel" style="
            padding:10px 16px;
            border-radius:16px;
            pointer-events:auto;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:8px;
            width:150px;
        ">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:bold;color:#facc15;">
                <span>âš¡ é€Ÿåº¦</span>
            </div>
            <input type="range" id="speedSlider" min="0.5" max="3.0" step="0.1" value="1.0">
            <div style="font-size:12px;font-family:monospace;color:#d1d5db;">
                <span id="speedValue">1.0</span>x
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ ‡ç­¾ -->
    <div style="
        position:absolute;left:0;right:0;bottom:32px;
        text-align:center;pointer-events:none;
    ">
        <p style="color:rgba(255,255,255,0.25);font-size:12px;font-family:monospace;">
            MODE: LOG SURVIVAL Â· 20 ROWS
        </p>
    </div>
</div>

<!-- ä¸»èœå• -->
<div id="menuLayer" class="overlay-fullscreen center-wrapper" style="
    background-image:linear-gradient(to bottom right,#111827,#020617);
    z-index:50;
">
    <div class="glass-panel" style="
        width:100%;
        max-width:360px;
        border-radius:32px;
        overflow:hidden;
        box-shadow:0 25px 50px rgba(0,0,0,0.7);
    ">
        <div style="
            height:230px;
            background-image:linear-gradient(to bottom,rgba(30,64,175,0.6),#020617);
            padding:24px;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            text-align:center;
            position:relative;
        ">
            <div style="
                position:absolute;inset:0;opacity:0.12;
                background-image:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmZmYiLz48L3N2Zz4=');
            "></div>
            <div style="
                margin-bottom:8px;padding:4px 12px;border-radius:999px;
                font-size:10px;font-weight:700;
                background:rgba(248,113,113,0.2);
                color:#fca5a5;border:1px solid rgba(248,113,113,0.3);
                letter-spacing:0.16em;text-transform:uppercase;
                position:relative;z-index:1;
            ">
                æéš¾ Â· å››åˆ™è¿ç®—
            </div>
            <h1 class="neon-text" style="
                font-size:40px;line-height:0.9;
                font-weight:900;color:#fff;margin:0 0 6px 0;
                letter-spacing:-0.05em;position:relative;z-index:1;
            ">
                LOG RUN
            </h1>
            <p style="color:#bfdbfe;font-size:14px;font-weight:500;position:relative;z-index:1;">
                æ•°å­— + âˆ’ Ã— Ã· Â· æ´»ä¸‹ 20 æ’å°±èµ¢
            </p>
        </div>
        <div style="padding:20px 20px 24px;background:rgba(15,23,42,0.95);">
            <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:22px;font-size:13px;">
                <div style="display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:4px;">
                    <span style="color:#9ca3af;">æ€»æ’æ•°</span>
                    <span style="font-family:monospace;font-weight:700;color:#fff;">20</span>
                </div>
                <div style="display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:4px;">
                    <span style="color:#9ca3af;">æœ€å¤§æ•°å€¼</span>
                    <span style="font-family:monospace;font-weight:700;color:#f97316;">999,999</span>
                </div>
                <div style="display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:4px;">
                    <span style="color:#9ca3af;">çƒç±»å‹æ¯”ä¾‹</span>
                    <span style="font-family:monospace;font-weight:700;color:#60a5fa;">
                        æ•°å­—70% / -15% / Ã—10% / Ã·5%
                    </span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startGame()">å¼€å§‹æŒ‘æˆ˜</button>
        </div>
    </div>
</div>

<!-- ç»“ç®—å±‚ -->
<div id="resultLayer" class="overlay-fullscreen center-wrapper" style="
    background:rgba(0,0,0,0.88);
    display:none;z-index:60;
">
    <div id="resultCard" class="glass-panel" style="
        width:100%;max-width:360px;
        border-radius:32px;
        padding:28px 24px 24px;
        text-align:center;
        box-shadow:0 25px 50px rgba(0,0,0,0.8);
        border:2px solid #4b5563;
    ">
        <div id="resultIcon" style="
            width:80px;height:80px;border-radius:999px;
            display:flex;align-items:center;justify-content:center;
            margin:0 auto 20px auto;
            border:4px solid #4b5563;
            box-shadow:0 10px 25px rgba(0,0,0,0.6);
            font-size:32px;
        ">ğŸ’€</div>
        <h2 id="resultTitle" style="
            font-size:22px;font-weight:900;color:#fff;
            margin:0 0 6px 0;
        ">
            æ¸¸æˆç»“æŸ
        </h2>
        <p id="resultDesc" style="
            margin:0 0 18px 0;
            font-weight:500;color:#9ca3af;font-size:13px;
        ">
            ç”Ÿå­˜æ˜¯å”¯ä¸€çš„æ³•åˆ™
        </p>
        <div style="
            background:rgba(255,255,255,0.04);
            border-radius:20px;
            padding:14px;
            margin-bottom:20px;
            border:1px solid rgba(255,255,255,0.1);
        ">
            <span style="
                display:block;font-size:10px;
                color:rgba(255,255,255,0.5);
                text-transform:uppercase;
                letter-spacing:0.16em;
                margin-bottom:4px;
            ">
                æœ€ç»ˆæ•°å€¼
            </span>
            <span id="finalScore" style="
                font-size:36px;font-weight:900;
                letter-spacing:-0.04em;color:#fff;
                font-family:monospace;
            ">
                0
            </span>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-light" onclick="startGame()">å†è¯•ä¸€æ¬¡</button>
            <button class="btn btn-secondary" onclick="showMenu()">è¿”å›ä¸»èœå•</button>
        </div>
    </div>
</div>

<script>
    /* ========= åŸºæœ¬é…ç½® ========= */
    var canvas = document.getElementById('gameCanvas');
    var ctx = canvas.getContext('2d');

    var LANES_COUNT = 8;
    var MAX_STEPS = 20;
    var MAX_VALUE_CAP = 999999;  // ç©å®¶æœ€å¤§å€¼
    var OPERAND_MAX = 999999;    // çƒä¸Šæ•°å­—æœ€å¤§å€¼

    // éš¾åº¦æ›²çº¿ï¼šéšç€æ’æ•°æå‡ï¼Œçº¯æ•°å­—çš„æœ€å¤§å€¼ä¸Šé™æé«˜
    var DIFFICULTY_CURVE = [
        { step: 4,  cap: 500 },
        { step: 7,  cap: 2000 },
        { step: 10, cap: 10000 },
        { step: 13, cap: 100000 },
        { step: 16, cap: 500000 },
        { step: 20, cap: 999999 }
    ];

    var gameRunning = false;
    var animationId;
    var frameCount = 0;
    var baseSpeed = 4;
    var speedMultiplier = 1.0;

    var rows = [];
    var totalSpawnedRows = 0;

    var player = {
        val: 2,
        x: 0,
        y: 0,
        radius: 20,
        targetX: 0
    };

    var gameState = {
        rowsPassed: 0
    };

    /* ========= ç”»å¸ƒå¤§å° & ç­‰æ¯”ä¾‹ ========= */
    function resizeCanvas() {
        var w = window.innerWidth || document.documentElement.clientWidth;
        var h = window.innerHeight || document.documentElement.clientHeight;
        canvas.width = w;
        canvas.height = h;
        if (!gameRunning) {
            player.x = canvas.width / 2;
            player.targetX = canvas.width / 2;
            player.y = canvas.height - 150;
            player.radius = calculateRadius(player.val);
        }
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', function () {
        setTimeout(resizeCanvas, 300);
    });
    resizeCanvas();

    // âœ… æ”¹å°çƒå°ºå¯¸ + å¢å¤§ç¼éš™çš„ç­‰æ¯”ä¾‹åŠå¾„å‡½æ•°
    function calculateRadius(val) {
        var scale = canvas.width / 430;  // ä»¥ ~iPhone 12 å®½åº¦ä¸ºåŸºå‡†

        // åŸºç¡€åŠå¾„å’Œå¢é•¿å¹…åº¦éƒ½æ¯”ä¹‹å‰æ›´å°
        var baseSize = 10 * scale;
        var logFactor = 2.5 * scale;

        var r = baseSize + Math.log(val + 1) * logFactor;

        // æœ€å¤§åŠå¾„ä» 0.8 ç¼©åˆ° 0.5 â†’ æ¯æ¡é“çš„ç©ºéš™æ˜æ˜¾å˜å¤§
        var laneHalf = canvas.width / LANES_COUNT / 2;
        var maxR = laneHalf * 0.5;  // åŸæ¥æ˜¯ 0.8

        return Math.min(r, maxR);
    }

    /* ========= æ“ä½œç±»å‹é€‰æ‹© ========= */
    // 70% æ•°å­—ï¼ˆåŠ ï¼‰ï¼Œ15% -æ•°å­—ï¼Œ10% Ã—æ•°å­—ï¼Œ5% Ã·æ•°å­—
    function randomOpType() {
        var p = Math.random();
        if (p < 0.70) return 'add';
        if (p < 0.85) return 'sub';
        if (p < 0.95) return 'mul';
        return 'div';
    }

    // è·å–å½“å‰æ’çš„â€œçº¯æ•°å­—â€éš¾åº¦ä¸Šé™
    function getDifficultyCap(currentStep) {
        for (var i = 0; i < DIFFICULTY_CURVE.length; i++) {
            var stage = DIFFICULTY_CURVE[i];
            if (currentStep < stage.step) return stage.cap;
        }
        return MAX_VALUE_CAP;
    }

    /* ========= è¾“å…¥æ§åˆ¶ ========= */
    function handleInput(clientX) {
        if (!gameRunning) return;
        var currentRadius = calculateRadius(player.val);
        var x = clientX;
        if (x < currentRadius) x = currentRadius;
        if (x > canvas.width - currentRadius) x = canvas.width - currentRadius;
        player.targetX = x;
    }

    canvas.addEventListener('mousemove', function(e) {
        handleInput(e.clientX);
    });

    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        if (e.touches && e.touches.length > 0) {
            handleInput(e.touches[0].clientX);
        }
    }, { passive: false });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        if (e.touches && e.touches.length > 0) {
            handleInput(e.touches[0].clientX);
        }
    }, { passive: false });

    var speedSlider = document.getElementById('speedSlider');
    var speedValue = document.getElementById('speedValue');
    speedSlider.addEventListener('input', function(e) {
        speedMultiplier = parseFloat(e.target.value);
        speedValue.innerText = speedMultiplier.toFixed(1);
    });

    /* ========= ç”Ÿæˆä¸€æ’ ========= */
    function spawnRow() {
        if (totalSpawnedRows >= MAX_STEPS) return;

        var laneWidth = canvas.width / LANES_COUNT;
        var currentCap = getDifficultyCap(gameState.rowsPassed);

        var newRowItems = [];
        // ä¿è¯è‡³å°‘ 1~2 ä¸ªâ€œæ¯”è¾ƒå®¹æ˜“æ´»â€çš„ add çƒ
        var safeSpots = Math.random() > 0.8 ? 2 : 1;

        for (var lane = 0; lane < LANES_COUNT; lane++) {
            var opType = randomOpType();
            var val;

            if (opType === 'add') {
                // çº¯æ•°å­—ï¼šå’Œä½ ä¹‹å‰é€»è¾‘ä¸€è‡´
                if (lane < safeSpots) {
                    // å®‰å…¨ï¼šæ•°å€¼ä¸è¶…è¿‡å½“å‰ç©å®¶
                    var maxFood = Math.max(1, player.val);
                    var vSafe = Math.floor(Math.random() * maxFood) + 1;
                    if (Math.random() > 0.7) vSafe = player.val;
                    val = vSafe;
                } else {
                    // å±é™©ï¼šå¤§äºç©å®¶çš„æ•°å­—
                    var minDanger = Math.max(player.val + 1, 1);
                    var maxDanger = currentCap;
                    if (minDanger > maxDanger) minDanger = maxDanger;
                    val = Math.floor(Math.random() * (maxDanger - minDanger + 1)) + minDanger;
                }
            } else if (opType === 'sub') {
                // -æ•°å­—ï¼šæ‰£è¡€ï¼Œå¤§å°å’Œç©å®¶ç›¸å…³ï¼Œé¿å…ä¸€åˆ€ç æ²¡
                var maxSub = Math.max(1, Math.floor(player.val * 0.8));
                val = Math.floor(Math.random() * maxSub) + 1;
            } else if (opType === 'mul') {
                // Ã—æ•°å­—ï¼šå°å€ç‡ï¼Œé¿å…ä¸€å£æ°”çˆ†ç‚¸åˆ°ä¸Šé™
                var minMul = 2, maxMul = 5;
                val = Math.floor(Math.random() * (maxMul - minMul + 1)) + minMul;
            } else { // 'div'
                // Ã·æ•°å­—ï¼š2~10
                var minDiv = 2, maxDiv = 10;
                val = Math.floor(Math.random() * (maxDiv - minDiv + 1)) + minDiv;
            }

            val = Math.max(1, Math.min(val, OPERAND_MAX));

            newRowItems.push({
                type: opType,       // 'add' | 'sub' | 'mul' | 'div'
                operand: val,       // çƒé‡Œçš„æ•°å­—
                x: lane * laneWidth + laneWidth / 2,
                y: -100,
                radius: calculateRadius(val),
                active: true
            });
        }

        rows.push({ items: newRowItems, passed: false });
        totalSpawnedRows++;
    }

    /* ========= ç¢°æ’åè¿ç®— ========= */
    function handleCollision(item) {
        if (!item.active) return;

        var n = item.operand;

        if (item.type === 'add') {
            // çº¯æ•°å­—ï¼šé€»è¾‘ä¸å˜â€”â€”ç©å®¶ < n å°±æ­»ï¼Œ>= n å°±åŠ 
            if (player.val < n) {
                endGame('defeat', n);
                return;
            }
            player.val = Math.min(MAX_VALUE_CAP, player.val + n);
        } else if (item.type === 'sub') {
            // -æ•°å­—ï¼šæ‰£è¡€ï¼Œæœ€ä½ 1
            player.val = Math.max(1, player.val - n);
        } else if (item.type === 'mul') {
            // Ã—æ•°å­—ï¼šä¹˜æ³•ï¼Œæœ€é«˜ 999999
            player.val = Math.min(MAX_VALUE_CAP, player.val * n);
        } else if (item.type === 'div') {
            // Ã·æ•°å­—ï¼šæ•´é™¤ï¼Œæœ€ä½ 1
            player.val = Math.max(1, Math.floor(player.val / n));
        }

        item.active = false;
        updateHUD();
    }

    /* ========= ä¸»å¾ªç¯ï¼šæ›´æ–° ========= */
    function update() {
        if (!gameRunning) return;

        var currentSpeed = baseSpeed * speedMultiplier;

        // ç©å®¶ä½ç½®å¹³æ»‘è·Ÿéš
        player.x += (player.targetX - player.x) * 0.2;
        player.radius = calculateRadius(player.val);

        var spawnDistance = 280;
        var spawnRate = Math.max(10, Math.floor(spawnDistance / currentSpeed));
        if (frameCount % spawnRate === 0 && totalSpawnedRows < MAX_STEPS) {
            spawnRow();
        }

        for (var i = rows.length - 1; i >= 0; i--) {
            var row = rows[i];

            // é€šè¿‡ä¸€æ•´æ’
            if (!row.passed && row.items.length > 0 && row.items[0].y > player.y) {
                row.passed = true;
                gameState.rowsPassed++;
                updateHUD();

                if (gameState.rowsPassed >= MAX_STEPS) {
                    setTimeout(function () {
                        endGame('victory');
                    }, 200);
                }
            }

            for (var j = 0; j < row.items.length; j++) {
                var item = row.items[j];
                if (!item.active) continue;

                item.y += currentSpeed;

                var dx = player.x - item.x;
                var dy = player.y - item.y;
                var dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < player.radius + item.radius - 3) {
                    handleCollision(item);
                    if (!gameRunning) return; // å¯èƒ½å·²ç» endGame
                }
            }

            // æ•´æ’é£å‡ºå±å¹•ä¸‹æ–¹ï¼Œåˆ æ‰
            if (row.items.length > 0 && row.items[0].y > canvas.height + 120) {
                rows.splice(i, 1);
            }
        }

        frameCount++;
    }

    /* ========= ç»˜åˆ¶ ========= */
    function draw() {
        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // èµ›é“ç«–çº¿
        ctx.strokeStyle = '#1f2933';
        ctx.lineWidth = 1;
        var laneWidth = canvas.width / LANES_COUNT;
        for (var i = 1; i < LANES_COUNT; i++) {
            ctx.beginPath();
            ctx.moveTo(i * laneWidth, 0);
            ctx.lineTo(i * laneWidth, canvas.height);
            ctx.stroke();
        }

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // æ‰€æœ‰çƒ
        rows.forEach(function(row) {
            row.items.forEach(function(item) {
                if (!item.active) return;

                var canEat = true;
                if (item.type === 'add') {
                    canEat = player.val >= item.operand;
                }

                ctx.beginPath();
                ctx.arc(item.x, item.y, item.radius, 0, Math.PI * 2);

                if (item.type === 'add') {
                    if (canEat) {
                        ctx.fillStyle = 'rgba(16, 185, 129, 0.9)';
                        ctx.strokeStyle = '#34d399';
                    } else {
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.9)';
                        ctx.strokeStyle = '#f87171';
                    }
                } else if (item.type === 'sub') {
                    ctx.fillStyle = 'rgba(245, 158, 11, 0.9)';
                    ctx.strokeStyle = '#fbbf24';
                } else if (item.type === 'mul') {
                    ctx.fillStyle = 'rgba(129, 140, 248, 0.9)';
                    ctx.strokeStyle = '#8b5cf6';
                } else { // div
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.9)';
                    ctx.strokeStyle = '#3b82f6';
                }

                ctx.fill();
                ctx.lineWidth = 2;
                ctx.stroke();

                var fontSize = Math.min(item.radius, 16);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold ' + fontSize + 'px monospace';

                var text;
                if (item.type === 'add')      text = String(item.operand);
                else if (item.type === 'sub') text = '-' + item.operand;
                else if (item.type === 'mul') text = 'Ã—' + item.operand;
                else                          text = 'Ã·' + item.operand;

                ctx.fillText(text, item.x, item.y);
            });
        });

        // ç©å®¶çƒ
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#3b82f6';
        ctx.fill();
        ctx.shadowBlur = 0;

        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius * 0.8, 0, Math.PI * 2);
        ctx.fillStyle = '#3b82f6';
        ctx.fill();

        var pFontSize = Math.min(player.radius, 18);
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold ' + pFontSize + 'px monospace';
        ctx.fillText(player.val, player.x, player.y);
    }

    /* ========= ä¸»å¾ªç¯ ========= */
    function gameLoop() {
        if (gameRunning) {
            update();
            draw();
            animationId = requestAnimationFrame(gameLoop);
        }
    }

    /* ========= HUD / UI ========= */
    function updateHUD() {
        document.getElementById('scoreDisplay').innerText = player.val;
        var remaining = MAX_STEPS - gameState.rowsPassed;
        document.getElementById('stepsDisplay').innerText = Math.max(0, remaining);
        var progress = (gameState.rowsPassed / MAX_STEPS) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function startGame() {
        gameRunning = true;
        player.val = 2;
        player.x = canvas.width / 2;
        player.targetX = canvas.width / 2;
        player.y = canvas.height - 150;
        player.radius = calculateRadius(player.val);

        rows = [];
        frameCount = 0;
        gameState.rowsPassed = 0;
        totalSpawnedRows = 0;

        document.getElementById('menuLayer').style.display = 'none';
        document.getElementById('resultLayer').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'block';

        updateHUD();
        cancelAnimationFrame(animationId);
        gameLoop();
    }

    function showMenu() {
        gameRunning = false;
        cancelAnimationFrame(animationId);
        document.getElementById('gameContainer').style.display = 'none';
        document.getElementById('resultLayer').style.display = 'none';
        document.getElementById('menuLayer').style.display = 'flex';
    }

    function endGame(result, killerVal) {
        gameRunning = false;
        cancelAnimationFrame(animationId);

        var card = document.getElementById('resultCard');
        var title = document.getElementById('resultTitle');
        var desc = document.getElementById('resultDesc');
        var icon = document.getElementById('resultIcon');
        var scoreDisplay = document.getElementById('finalScore');

        scoreDisplay.innerText = player.val;
        document.getElementById('resultLayer').style.display = 'flex';

        if (result === 'victory') {
            card.style.borderColor = '#22c55e';
            title.innerText = 'ç”Ÿå­˜å¤§å¸ˆï¼';
            title.style.color = '#22c55e';
            desc.innerText = 'ä½ åœ¨ 20 æ’å››åˆ™è¿ç®—åœ°ç‹±ä¸­æˆåŠŸæ´»äº†ä¸‹æ¥ã€‚';
            icon.innerText = 'ğŸ‘‘';
            icon.style.background = 'rgba(34,197,94,0.2)';
            icon.style.borderColor = '#22c55e';
            icon.style.color = '#ffffff';
        } else {
            card.style.borderColor = '#ef4444';
            title.innerText = 'æƒ¨é­ç¢¾å‹';
            title.style.color = '#ef4444';
            desc.innerText = 'ä½ è¢« ' + (killerVal || 'æŸä¸ªæ•°å­—') + ' å½“åœºæ‹ç¢ã€‚';
            icon.innerText = 'ğŸ’¥';
            icon.style.background = 'rgba(248,113,113,0.2)';
            icon.style.borderColor = '#ef4444';
            icon.style.color = '#ef4444';
        }
    }
</script>
</body>
</html>